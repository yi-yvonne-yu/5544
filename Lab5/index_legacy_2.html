<!doctype html>
<meta charset="utf-8" />
<title>Life Expectancy by Region (WDI)</title>
<style>
  :root { color-scheme: light white; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
  h1 { font-size: 18px; margin: 0 0 12px; }
  .legend { font-size: 12px; }
  .tooltip {
    position:absolute; pointer-events:none; background:#fff; border:1px solid #ccc;
    padding:6px 8px; border-radius:6px; font-size:12px; box-shadow:0 1px 6px rgba(0,0,0,.1);
    opacity:0;
  }
  .controls { margin: 8px 0 12px; display:flex; gap:8px; }
  button {
    padding:6px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer;
  }
  button[aria-pressed="true"] { background:#f3f4f6; font-weight:600; }
</style>

<h1>Life Expectancy at Birth by World Bank Region (1960â€“2023)</h1>

<div class="controls">
  <button id="btn-full" aria-pressed="true">Full sample</button>
  <button id="btn-20">20% sample</button>
</div>

<div id="chart"></div>
<div id="tooltip" class="tooltip"></div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
const width = 900, height = 520;
const margin = { top: 20, right: 140, bottom: 40, left: 110 }; // extra left room
const labelPadding = 70; // distance left of axis for the y-label

const files = {
  full: "data/life_expectancy_regions.csv",
  p20:  "data/life_expectancy_regions_sample.csv"
};

const tip = d3.select("#tooltip");

function showTip(evt, html) {
  tip.style("opacity", 1)
     .style("left", (evt.pageX + 10) + "px")
     .style("top",  (evt.pageY + 10) + "px")
     .html(html);
}
function hideTip() { tip.style("opacity", 0); }

// Build (or rebuild) the chart from a given CSV file
async function render(file) {
  // Load data: Region,Year,LifeExpectancy
  const data = await d3.csv(file, d => ({
    Region: d.Region,
    Year: +d.Year,
    LifeExpectancy: +d.LifeExpectancy
  }));

  // Group into series per region
  const series = d3.groups(data, d => d.Region)
                   .map(([region, values]) => ({
                     region,
                     values: values.sort((a,b) => d3.ascending(a.Year, b.Year))
                   }));

  // Scales
  const years = d3.extent(data, d => d.Year);
  const x = d3.scaleLinear().domain(years).range([margin.left, width - margin.right]);

  const y = d3.scaleLinear()
      .domain(d3.extent(data, d => d.LifeExpectancy)).nice()
      .range([height - margin.bottom, margin.top]);

  const color = d3.scaleOrdinal()
      .domain(series.map(s => s.region))
      .range(d3.schemeTableau10.concat(d3.schemeSet2));

  // Clear old svg (if any) and create a fresh one
  d3.select("#chart").selectAll("svg").remove();
  const svg = d3.select("#chart").append("svg")
      .attr("viewBox", [0, 0, width, height]);

  // Axes
  svg.append("g")
     .attr("transform", `translate(0,${height - margin.bottom})`)
     .call(d3.axisBottom(x).ticks(10).tickFormat(d3.format("d")))
     .call(g => g.append("text")
       .attr("x", width - margin.right).attr("y", 30)
       .attr("fill", "currentColor").attr("text-anchor", "end").text("Year"));

  svg.append("g")
     .attr("transform", `translate(${margin.left},0)`)
     .call(d3.axisLeft(y));

  // y-axis label OUTSIDE on the left
  svg.append("text")
     .attr("transform", `translate(${margin.left - labelPadding}, ${height/2}) rotate(-90)`)
     .attr("text-anchor", "middle")
     .attr("dominant-baseline", "central")
     .attr("font-size", 12)
     .text("Life expectancy (years)");

  // Line generator
  const line = d3.line()
      .defined(d => Number.isFinite(d.LifeExpectancy))
      .x(d => x(d.Year))
      .y(d => y(d.LifeExpectancy));

  // Draw lines
  svg.append("g")
    .selectAll("path")
    .data(series)
    .join("path")
      .attr("fill", "none")
      .attr("stroke", d => color(d.region))
      .attr("stroke-width", 2)
      .attr("d", d => line(d.values))
      .on("mousemove", (evt, d) => showTip(evt, `<b>${d.region}</b>`))
      .on("mouseleave", hideTip);

  // Legend
  const legend = svg.append("g").attr("transform", `translate(${width - margin.right + 10}, ${margin.top})`);
  const item = legend.selectAll("g").data(series).join("g")
      .attr("transform", (d, i) => `translate(0, ${i*18})`);
  item.append("rect").attr("width", 12).attr("height", 12).attr("fill", d => color(d.region));
  item.append("text").attr("x", 18).attr("y", 10).attr("class", "legend").text(d => d.region);
}

// Wire up buttons
const btnFull = document.getElementById("btn-full");
const btn20   = document.getElementById("btn-20");

function setActive(which) {
  btnFull.setAttribute("aria-pressed", which === "full");
  btn20.setAttribute("aria-pressed", which === "p20");
}

btnFull.addEventListener("click", () => { setActive("full"); render(files.full); });
btn20.addEventListener("click",   () => { setActive("p20");  render(files.p20);  });

// Initial render with full dataset
render(files.full);
</script>
